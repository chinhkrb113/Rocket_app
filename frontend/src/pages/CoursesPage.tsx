import React, { useState, useEffect } from 'react';
import { useAppDispatch, useAppSelector } from '../hooks/redux';
import Layout from '../components/layout/Layout';
import Button from '../components/common/Button';
import Input from '../components/common/Input';
import { mockCourses, type Course } from '../data/mockData';
import './CoursesPage.css';

const CoursesPage: React.FC = () => {
  const [courses, setCourses] = useState<Course[]>([]);
  const [filteredCourses, setFilteredCourses] = useState<Course[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [categoryFilter, setCategoryFilter] = useState<string>('all');
  const [levelFilter, setLevelFilter] = useState<string>('all');
  const [statusFilter, setStatusFilter] = useState<string>('all');
  const [sortBy, setSortBy] = useState<string>('title');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('asc');
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [showAddModal, setShowAddModal] = useState(false);

  // Load mock data
  useEffect(() => {
    setCourses(mockCourses);
    setFilteredCourses(mockCourses);
  }, []);

  // Filter and search logic
  useEffect(() => {
    let filtered = courses.filter(course => {
      const matchesSearch = course.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                           course.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                           course.instructor.toLowerCase().includes(searchTerm.toLowerCase()) ||
                           course.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()));
      
      const matchesCategory = categoryFilter === 'all' || course.category === categoryFilter;
      const matchesLevel = levelFilter === 'all' || course.level === levelFilter;
      const matchesStatus = statusFilter === 'all' || course.status === statusFilter;
      
      return matchesSearch && matchesCategory && matchesLevel && matchesStatus;
    });

    // Sort
    filtered.sort((a, b) => {
      let aValue: any, bValue: any;
      
      switch (sortBy) {
        case 'title':
          aValue = a.title;
          bValue = b.title;
          break;
        case 'rating':
          aValue = a.rating;
          bValue = b.rating;
          break;
        case 'studentsCount':
          aValue = a.studentsCount;
          bValue = b.studentsCount;
          break;
        case 'price':
          aValue = a.price;
          bValue = b.price;
          break;
        case 'createdAt':
          aValue = new Date(a.createdAt);
          bValue = new Date(b.createdAt);
          break;
        default:
          aValue = a.title;
          bValue = b.title;
      }
      
      if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
      if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
      return 0;
    });

    setFilteredCourses(filtered);
  }, [courses, searchTerm, categoryFilter, levelFilter, statusFilter, sortBy, sortOrder]);

  const getLevelColor = (level: string) => {
    switch (level) {
      case 'beginner': return '#10b981';
      case 'intermediate': return '#f59e0b';
      case 'advanced': return '#ef4444';
      default: return '#6b7280';
    }
  };

  const getLevelLabel = (level: string) => {
    switch (level) {
      case 'beginner': return 'C∆° b·∫£n';
      case 'intermediate': return 'Trung c·∫•p';
      case 'advanced': return 'N√¢ng cao';
      default: return level;
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'published': return '#10b981';
      case 'draft': return '#f59e0b';
      case 'archived': return '#6b7280';
      default: return '#6b7280';
    }
  };

  const getStatusLabel = (status: string) => {
    switch (status) {
      case 'published': return 'ƒê√£ xu·∫•t b·∫£n';
      case 'draft': return 'B·∫£n nh√°p';
      case 'archived': return 'ƒê√£ l∆∞u tr·ªØ';
      default: return status;
    }
  };

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND'
    }).format(price);
  };

  const formatDuration = (hours: number) => {
    return `${hours} gi·ªù`;
  };

  const uniqueCategories = Array.from(new Set(courses.map(c => c.category)));

  return (
    <Layout>
      <div className="courses-page">
        {/* Header */}
        <div className="page-header">
          <div className="header-content">
            <div className="header-text">
              <h1>Qu·∫£n l√Ω kh√≥a h·ªçc</h1>
              <p>T·∫°o v√† qu·∫£n l√Ω n·ªôi dung ƒë√†o t·∫°o</p>
            </div>
            <div className="header-actions">
              <Button
                variant="outline"
                onClick={() => setShowAddModal(true)}
              >
                <span>üìä</span>
                B√°o c√°o
              </Button>
              <Button
                variant="primary"
                onClick={() => setShowAddModal(true)}
              >
                <span>‚ûï</span>
                T·∫°o kh√≥a h·ªçc
              </Button>
            </div>
          </div>
        </div>

        {/* Stats Cards */}
        <div className="stats-grid">
          <div className="stat-card">
            <div className="stat-icon">üìö</div>
            <div className="stat-content">
              <h3>{courses.length}</h3>
              <p>T·ªïng kh√≥a h·ªçc</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon">‚úÖ</div>
            <div className="stat-content">
              <h3>{courses.filter(c => c.status === 'active').length}</h3>
              <p>ƒêang ho·∫°t ƒë·ªông</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon">üë•</div>
            <div className="stat-content">
              <h3>{courses.reduce((acc, c) => acc + c.studentsCount, 0)}</h3>
              <p>T·ªïng h·ªçc vi√™n</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon">‚≠ê</div>
            <div className="stat-content">
              <h3>{(courses.reduce((acc, c) => acc + c.rating, 0) / courses.length).toFixed(1)}</h3>
              <p>ƒê√°nh gi√° trung b√¨nh</p>
            </div>
          </div>
        </div>

        {/* Filters and Search */}
        <div className="filters-section">
          <div className="search-filters">
            <div className="search-container">
              <Input
                placeholder="T√¨m ki·∫øm kh√≥a h·ªçc..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}

              />
            </div>
            
            <div className="filter-group">
              <select 
                value={categoryFilter} 
                onChange={(e) => setCategoryFilter(e.target.value)}
                className="filter-select"
              >
                <option value="all">T·∫•t c·∫£ danh m·ª•c</option>
                {uniqueCategories.map(category => (
                  <option key={category} value={category}>{category}</option>
                ))}
              </select>
              
              <select 
                value={levelFilter} 
                onChange={(e) => setLevelFilter(e.target.value)}
                className="filter-select"
              >
                <option value="all">T·∫•t c·∫£ c·∫•p ƒë·ªô</option>
                <option value="beginner">C∆° b·∫£n</option>
                <option value="intermediate">Trung c·∫•p</option>
                <option value="advanced">N√¢ng cao</option>
              </select>
              
              <select 
                value={statusFilter} 
                onChange={(e) => setStatusFilter(e.target.value)}
                className="filter-select"
              >
                <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="published">ƒê√£ xu·∫•t b·∫£n</option>
                <option value="draft">B·∫£n nh√°p</option>
                <option value="archived">ƒê√£ l∆∞u tr·ªØ</option>
              </select>
            </div>
          </div>
          
          <div className="view-controls">
            <div className="view-toggle">
              <button 
                className={`view-btn ${viewMode === 'grid' ? 'active' : ''}`}
                onClick={() => setViewMode('grid')}
              >
                ‚äû
              </button>
              <button 
                className={`view-btn ${viewMode === 'list' ? 'active' : ''}`}
                onClick={() => setViewMode('list')}
              >
                üìã
              </button>
            </div>
            
            <select 
              value={`${sortBy}-${sortOrder}`} 
              onChange={(e) => {
                const [field, order] = e.target.value.split('-');
                setSortBy(field);
                setSortOrder(order as 'asc' | 'desc');
              }}
              className="sort-select"
            >
              <option value="title-asc">T√™n A-Z</option>
              <option value="title-desc">T√™n Z-A</option>
              <option value="rating-desc">ƒê√°nh gi√° cao nh·∫•t</option>
              <option value="studentsCount-desc">Nhi·ªÅu h·ªçc vi√™n nh·∫•t</option>
              <option value="price-asc">Gi√° th·∫•p nh·∫•t</option>
              <option value="price-desc">Gi√° cao nh·∫•t</option>
              <option value="createdAt-desc">M·ªõi nh·∫•t</option>
            </select>
          </div>
        </div>

        {/* Courses Grid/List */}
        <div className={`courses-container ${viewMode}`}>
          {filteredCourses.map(course => (
            <div key={course.id} className="course-card">
              <div className="course-thumbnail">
                <img src={course.thumbnail} alt={course.title} />
                <div className="course-overlay">
                  <div className="overlay-actions">
                    <button className="action-btn" title="Xem tr∆∞·ªõc">
                      üëÅÔ∏è
                    </button>
                    <button className="action-btn" title="Ch·ªânh s·ª≠a">
                      ‚úèÔ∏è
                    </button>
                    <button className="action-btn" title="Sao ch√©p">
                      üìã
                    </button>
                  </div>
                </div>
                <div className="course-badges">
                  <span 
                    className="level-badge" 
                    style={{ backgroundColor: getLevelColor(course.level) }}
                  >
                    {getLevelLabel(course.level)}
                  </span>
                  <span 
                    className="status-badge" 
                    style={{ backgroundColor: getStatusColor(course.status) }}
                  >
                    {getStatusLabel(course.status)}
                  </span>
                </div>
              </div>
              
              <div className="course-content">
                <div className="course-header">
                  <h3 className="course-title">{course.title}</h3>
                  <div className="course-category">{course.category}</div>
                </div>
                
                <p className="course-description">{course.description}</p>
                
                <div className="course-instructor">
                  <span className="instructor-icon">üë®‚Äçüè´</span>
                  <span>{course.instructor}</span>
                </div>
                
                <div className="course-stats">
                  <div className="stat-item">
                    <span className="stat-icon">‚≠ê</span>
                    <span className="stat-value">{course.rating}</span>
                  </div>
                  <div className="stat-item">
                    <span className="stat-icon">üë•</span>
                    <span className="stat-value">{course.studentsCount}</span>
                  </div>
                  <div className="stat-item">
                    <span className="stat-icon">üìñ</span>
                    <span className="stat-value">{course.lessonsCount} b√†i</span>
                  </div>
                  <div className="stat-item">
                    <span className="stat-icon">‚è±Ô∏è</span>
                    <span className="stat-value">{formatDuration(course.duration)}</span>
                  </div>
                </div>
                
                <div className="course-progress">
                  <div className="progress-header">
                    <span>H·ªçc vi√™n ƒë√£ ƒëƒÉng k√Ω</span>
                    <span>{course.studentsCount}</span>
                  </div>
                  <div className="progress-bar">
                    <div
                      className="progress-fill"
                      style={{ width: `${Math.min((course.studentsCount / 300) * 100, 100)}%` }}
                    ></div>
                  </div>
                </div>
                
                <div className="course-tags">
                  {course.tags.map(tag => (
                    <span key={tag} className="tag">{tag}</span>
                  ))}
                </div>
              </div>
              
              <div className="course-footer">
                <div className="course-price">
                  <span className="price">{formatPrice(course.price)}</span>
                </div>
                <div className="course-actions">
                  <Button variant="outline" size="small">
                    üìä Th·ªëng k√™
                  </Button>
                  <Button variant="primary" size="small">
                    ‚úèÔ∏è Ch·ªânh s·ª≠a
                  </Button>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Empty State */}
        {filteredCourses.length === 0 && (
          <div className="empty-state">
            <div className="empty-icon">üìö</div>
            <h3>Kh√¥ng t√¨m th·∫•y kh√≥a h·ªçc</h3>
            <p>Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c t·∫°o kh√≥a h·ªçc m·ªõi</p>
            <Button variant="primary" onClick={() => setShowAddModal(true)}>
              T·∫°o kh√≥a h·ªçc ƒë·∫ßu ti√™n
            </Button>
          </div>
        )}

        {/* Results Info */}
        {filteredCourses.length > 0 && (
          <div className="results-info">
            Hi·ªÉn th·ªã {filteredCourses.length} kh√≥a h·ªçc
          </div>
        )}
      </div>
    </Layout>
  );
};

export default CoursesPage;