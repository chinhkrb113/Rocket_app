import React, { useState, useEffect } from 'react';
import { mockExtendedStudents, mockTasks, mockEvaluations } from '../../data/mockData';
import { type ExtendedStudent, type Task, type Evaluation } from '../../types/student';
import './StudentWarningSystem.css';

interface StudentWarningSystemProps {
  currentUser?: any;
  students?: ExtendedStudent[];
  tasks?: Task[];
  evaluations?: Evaluation[];
}

interface WarningAlert {
  id: string;
  studentId: string;
  studentName: string;
  type: 'attendance' | 'performance' | 'deadline' | 'behavior' | 'dropout_risk';
  severity: 'low' | 'medium' | 'high' | 'critical';
  title: string;
  description: string;
  autoGenerated: boolean;
  createdAt: string;
  status: 'pending' | 'sent' | 'acknowledged' | 'resolved';
  actions: string[];
}

interface WarningTemplate {
  id: string;
  type: string;
  title: string;
  content: string;
  severity: string;
}

const StudentWarningSystem: React.FC<StudentWarningSystemProps> = ({
  currentUser,
  students = mockExtendedStudents,
  tasks = mockTasks,
  evaluations = mockEvaluations
}) => {
  const [warnings, setWarnings] = useState<WarningAlert[]>([]);
  const [selectedWarning, setSelectedWarning] = useState<WarningAlert | null>(null);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [filterType, setFilterType] = useState<string>('all');
  const [filterSeverity, setFilterSeverity] = useState<string>('all');
  const [filterStatus, setFilterStatus] = useState<string>('all');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  
  // Form states
  const [newWarning, setNewWarning] = useState({
    studentId: '',
    type: 'performance' as WarningAlert['type'],
    severity: 'medium' as WarningAlert['severity'],
    title: '',
    description: '',
    actions: [] as string[]
  });

  const warningTemplates: WarningTemplate[] = [
    {
      id: '1',
      type: 'attendance',
      title: 'C·∫£nh b√°o v·∫Øng m·∫∑t',
      content: 'B·∫°n ƒë√£ v·∫Øng m·∫∑t {count} bu·ªïi h·ªçc g·∫ßn ƒë√¢y. Vui l√≤ng tham gia ƒë·∫ßy ƒë·ªß c√°c bu·ªïi h·ªçc ti·∫øp theo ƒë·ªÉ kh√¥ng b·ªã ·∫£nh h∆∞·ªüng ƒë·∫øn k·∫øt qu·∫£ h·ªçc t·∫≠p.',
      severity: 'medium'
    },
    {
      id: '2',
      type: 'performance',
      title: 'C·∫£nh b√°o hi·ªáu su·∫•t h·ªçc t·∫≠p',
      content: 'ƒêi·ªÉm s·ªë c·ªßa b·∫°n ƒëang ·ªü m·ª©c th·∫•p ({score}/100). B·∫°n c·∫ßn c·∫£i thi·ªán hi·ªáu su·∫•t h·ªçc t·∫≠p v√† tham gia t√≠ch c·ª±c h∆°n v√†o c√°c ho·∫°t ƒë·ªông l·ªõp h·ªçc.',
      severity: 'high'
    },
    {
      id: '3',
      type: 'deadline',
      title: 'C·∫£nh b√°o tr·ªÖ h·∫°n n·ªôp b√†i',
      content: 'B·∫°n ƒë√£ n·ªôp mu·ªôn {count} b√†i t·∫≠p g·∫ßn ƒë√¢y. Vui l√≤ng qu·∫£n l√Ω th·ªùi gian t·ªët h∆°n v√† n·ªôp b√†i ƒë√∫ng h·∫°n.',
      severity: 'medium'
    },
    {
      id: '4',
      type: 'dropout_risk',
      title: 'C·∫£nh b√°o nguy c∆° b·ªè h·ªçc',
      content: 'D·ª±a tr√™n ph√¢n t√≠ch AI, b·∫°n ƒëang c√≥ nguy c∆° cao b·ªè h·ªçc. Vui l√≤ng li√™n h·ªá v·ªõi gi·∫£ng vi√™n ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n v√† h·ªó tr·ª£.',
      severity: 'critical'
    },
    {
      id: '5',
      type: 'behavior',
      title: 'C·∫£nh b√°o h√†nh vi',
      content: 'H√†nh vi c·ªßa b·∫°n trong l·ªõp h·ªçc c·∫ßn ƒë∆∞·ª£c c·∫£i thi·ªán. Vui l√≤ng tu√¢n th·ªß quy ƒë·ªãnh v√† t√¥n tr·ªçng gi·∫£ng vi√™n c≈©ng nh∆∞ c√°c b·∫°n h·ªçc.',
      severity: 'high'
    }
  ];

  useEffect(() => {
    generateAutoWarnings();
  }, [students, tasks, evaluations]);

  const generateAutoWarnings = async () => {
    setIsAnalyzing(true);
    const autoWarnings: WarningAlert[] = [];

    students.forEach(student => {
      const studentTasks = tasks.filter(t => t.assignedTo.includes(student.id));
      const studentEvaluations = evaluations.filter(e => e.evaluatedId === student.id);
      
      // Check attendance (using progress as proxy for attendance)
      const attendanceRate = student.progress || 0;
      if (attendanceRate < 70) {
        autoWarnings.push({
          id: `auto-attendance-${student.id}`,
          studentId: student.id,
          studentName: student.fullName,
          type: 'attendance',
          severity: attendanceRate < 50 ? 'critical' : 'high',
          title: 'T·ª∑ l·ªá v·∫Øng m·∫∑t cao',
          description: `H·ªçc vi√™n c√≥ t·ª∑ l·ªá v·∫Øng m·∫∑t ${100 - attendanceRate}%. C·∫ßn can thi·ªáp ngay l·∫≠p t·ª©c.`,
          autoGenerated: true,
          createdAt: new Date().toISOString(),
          status: 'pending',
          actions: ['Li√™n h·ªá h·ªçc vi√™n', 'G·∫∑p ph·ª• huynh', 'T∆∞ v·∫•n h·ªçc t·∫≠p']
        });
      }
      
      // Check task completion
      const overdueTasks = studentTasks.filter(t => 
        t.status !== 'completed' && new Date(t.dueDate) < new Date()
      );
      
      if (overdueTasks.length >= 3) {
        autoWarnings.push({
          id: `auto-deadline-${student.id}`,
          studentId: student.id,
          studentName: student.fullName,
          type: 'deadline',
          severity: overdueTasks.length >= 5 ? 'critical' : 'high',
          title: 'Nhi·ªÅu b√†i t·∫≠p qu√° h·∫°n',
          description: `H·ªçc vi√™n c√≥ ${overdueTasks.length} b√†i t·∫≠p ch∆∞a ho√†n th√†nh v√† ƒë√£ qu√° h·∫°n.`,
          autoGenerated: true,
          createdAt: new Date().toISOString(),
          status: 'pending',
          actions: ['Gia h·∫°n b√†i t·∫≠p', 'H·ªó tr·ª£ h·ªçc t·∫≠p', 'ƒêi·ªÅu ch·ªânh l·ªô tr√¨nh']
        });
      }
      
      // Check performance
      if (studentEvaluations.length > 0) {
        const avgScore = studentEvaluations.reduce((sum, evaluation) => sum + evaluation.overallScore, 0) / studentEvaluations.length;
        
        if (avgScore < 50) {
          autoWarnings.push({
            id: `auto-performance-${student.id}`,
            studentId: student.id,
            studentName: student.fullName,
            type: 'performance',
            severity: avgScore < 30 ? 'critical' : 'high',
            title: 'Hi·ªáu su·∫•t h·ªçc t·∫≠p th·∫•p',
            description: `ƒêi·ªÉm trung b√¨nh c·ªßa h·ªçc vi√™n ch·ªâ ƒë·∫°t ${avgScore.toFixed(1)}/100.`,
            autoGenerated: true,
            createdAt: new Date().toISOString(),
            status: 'pending',
            actions: ['T∆∞ v·∫•n h·ªçc t·∫≠p', 'L·ªõp b·ªï tr·ª£', 'Thay ƒë·ªïi ph∆∞∆°ng ph√°p h·ªçc']
          });
        }
      }
      
      // AI-based dropout risk analysis
      const completionRate = studentTasks.length > 0 
        ? (studentTasks.filter(t => t.status === 'completed').length / studentTasks.length) * 100 
        : 0;
      
      const riskScore = (
        (student.progress || 0) * 0.4 +
        completionRate * 0.3 +
        (studentEvaluations.length > 0
          ? studentEvaluations.reduce((sum, evaluation) => sum + evaluation.overallScore, 0) / studentEvaluations.length
          : 0) * 0.3
      );
      
      if (riskScore < 40) {
        autoWarnings.push({
          id: `auto-dropout-${student.id}`,
          studentId: student.id,
          studentName: student.fullName,
          type: 'dropout_risk',
          severity: 'critical',
          title: 'Nguy c∆° b·ªè h·ªçc cao',
          description: `AI ph√¢n t√≠ch cho th·∫•y h·ªçc vi√™n c√≥ nguy c∆° b·ªè h·ªçc cao (ƒëi·ªÉm r·ªßi ro: ${riskScore.toFixed(1)}/100).`,
          autoGenerated: true,
          createdAt: new Date().toISOString(),
          status: 'pending',
          actions: ['T∆∞ v·∫•n kh·∫©n c·∫•p', 'G·∫∑p ph·ª• huynh', 'ƒêi·ªÅu ch·ªânh ch∆∞∆°ng tr√¨nh', 'H·ªó tr·ª£ t√†i ch√≠nh']
        });
      }
    });

    setWarnings(autoWarnings);
    setIsAnalyzing(false);
  };

  const getSeverityColor = (severity: WarningAlert['severity']) => {
    switch (severity) {
      case 'low': return '#10b981';
      case 'medium': return '#f59e0b';
      case 'high': return '#f97316';
      case 'critical': return '#ef4444';
      default: return '#6b7280';
    }
  };

  const getSeverityLabel = (severity: WarningAlert['severity']) => {
    switch (severity) {
      case 'low': return 'Th·∫•p';
      case 'medium': return 'Trung b√¨nh';
      case 'high': return 'Cao';
      case 'critical': return 'Nghi√™m tr·ªçng';
      default: return severity;
    }
  };

  const getTypeLabel = (type: WarningAlert['type']) => {
    switch (type) {
      case 'attendance': return 'V·∫Øng m·∫∑t';
      case 'performance': return 'Hi·ªáu su·∫•t';
      case 'deadline': return 'Tr·ªÖ h·∫°n';
      case 'behavior': return 'H√†nh vi';
      case 'dropout_risk': return 'Nguy c∆° b·ªè h·ªçc';
      default: return type;
    }
  };

  const getStatusLabel = (status: WarningAlert['status']) => {
    switch (status) {
      case 'pending': return 'Ch·ªù x·ª≠ l√Ω';
      case 'sent': return 'ƒê√£ g·ª≠i';
      case 'acknowledged': return 'ƒê√£ x√°c nh·∫≠n';
      case 'resolved': return 'ƒê√£ gi·∫£i quy·∫øt';
      default: return status;
    }
  };

  const handleCreateWarning = () => {
    if (!newWarning.studentId || !newWarning.title || !newWarning.description) return;

    const warning: WarningAlert = {
      id: `manual-${Date.now()}`,
      studentId: newWarning.studentId,
      studentName: students.find(s => s.id === newWarning.studentId)?.fullName || '',
      type: newWarning.type,
      severity: newWarning.severity,
      title: newWarning.title,
      description: newWarning.description,
      autoGenerated: false,
      createdAt: new Date().toISOString(),
      status: 'pending',
      actions: newWarning.actions
    };

    setWarnings([...warnings, warning]);
    setShowCreateModal(false);
    setNewWarning({
      studentId: '',
      type: 'performance',
      severity: 'medium',
      title: '',
      description: '',
      actions: []
    });
  };

  const handleSendWarning = (warningId: string) => {
    setWarnings(warnings.map(w => 
      w.id === warningId ? { ...w, status: 'sent' as const } : w
    ));
    alert('ƒê√£ g·ª≠i c·∫£nh b√°o ƒë·∫øn h·ªçc vi√™n!');
  };

  const filteredWarnings = warnings.filter(warning => {
    if (filterType !== 'all' && warning.type !== filterType) return false;
    if (filterSeverity !== 'all' && warning.severity !== filterSeverity) return false;
    if (filterStatus !== 'all' && warning.status !== filterStatus) return false;
    return true;
  });



  return (
    <div className="student-warning-system">
      {/* Header */}
      <div className="warning-header">
        <div className="header-content">
          <h2>‚ö†Ô∏è H·ªá th·ªëng c·∫£nh b√°o h·ªçc vi√™n</h2>
          <p>Theo d√µi v√† qu·∫£n l√Ω c·∫£nh b√°o cho h·ªçc vi√™n</p>
        </div>
        <div className="header-actions">
          <button 
            className="analyze-btn"
            onClick={generateAutoWarnings}
            disabled={isAnalyzing}
          >
            {isAnalyzing ? 'üîÑ ƒêang ph√¢n t√≠ch...' : 'ü§ñ Ph√¢n t√≠ch t·ª± ƒë·ªông'}
          </button>
          <button 
            className="create-btn"
            onClick={() => setShowCreateModal(true)}
          >
            ‚ûï T·∫°o c·∫£nh b√°o
          </button>
        </div>
      </div>

      {/* Filters */}
      <div className="warning-filters">
        <div className="filter-group">
          <label>Lo·∫°i c·∫£nh b√°o:</label>
          <select value={filterType} onChange={(e) => setFilterType(e.target.value)}>
            <option value="all">T·∫•t c·∫£</option>
            <option value="attendance">V·∫Øng m·∫∑t</option>
            <option value="performance">Hi·ªáu su·∫•t</option>
            <option value="deadline">Tr·ªÖ h·∫°n</option>
            <option value="behavior">H√†nh vi</option>
            <option value="dropout_risk">Nguy c∆° b·ªè h·ªçc</option>
          </select>
        </div>
        
        <div className="filter-group">
          <label>M·ª©c ƒë·ªô:</label>
          <select value={filterSeverity} onChange={(e) => setFilterSeverity(e.target.value)}>
            <option value="all">T·∫•t c·∫£</option>
            <option value="low">Th·∫•p</option>
            <option value="medium">Trung b√¨nh</option>
            <option value="high">Cao</option>
            <option value="critical">Nghi√™m tr·ªçng</option>
          </select>
        </div>
        
        <div className="filter-group">
          <label>Tr·∫°ng th√°i:</label>
          <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}>
            <option value="all">T·∫•t c·∫£</option>
            <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
            <option value="sent">ƒê√£ g·ª≠i</option>
            <option value="acknowledged">ƒê√£ x√°c nh·∫≠n</option>
            <option value="resolved">ƒê√£ gi·∫£i quy·∫øt</option>
          </select>
        </div>
      </div>

      {/* Statistics */}
      <div className="warning-stats">
        <div className="stat-card critical">
          <div className="stat-number">{warnings.filter(w => w.severity === 'critical').length}</div>
          <div className="stat-label">Nghi√™m tr·ªçng</div>
        </div>
        <div className="stat-card high">
          <div className="stat-number">{warnings.filter(w => w.severity === 'high').length}</div>
          <div className="stat-label">M·ª©c cao</div>
        </div>
        <div className="stat-card pending">
          <div className="stat-number">{warnings.filter(w => w.status === 'pending').length}</div>
          <div className="stat-label">Ch·ªù x·ª≠ l√Ω</div>
        </div>
        <div className="stat-card auto">
          <div className="stat-number">{warnings.filter(w => w.autoGenerated).length}</div>
          <div className="stat-label">T·ª± ƒë·ªông</div>
        </div>
      </div>

      {/* Warnings List */}
      <div className="warnings-list">
        {filteredWarnings.length === 0 ? (
          <div className="empty-state">
            <div className="empty-icon">‚úÖ</div>
            <h3>Kh√¥ng c√≥ c·∫£nh b√°o n√†o</h3>
            <p>T·∫•t c·∫£ h·ªçc vi√™n ƒëang h·ªçc t·∫≠p t·ªët!</p>
          </div>
        ) : (
          filteredWarnings.map(warning => (
            <div key={warning.id} className={`warning-card ${warning.severity}`}>
              <div className="warning-header-card">
                <div className="warning-info">
                  <div className="warning-title">{warning.title}</div>
                  <div className="warning-meta">
                    <span className="student-name">üë§ {warning.studentName}</span>
                    <span className="warning-type">{getTypeLabel(warning.type)}</span>
                    <span 
                      className="severity-badge"
                      style={{ backgroundColor: getSeverityColor(warning.severity) }}
                    >
                      {getSeverityLabel(warning.severity)}
                    </span>
                    {warning.autoGenerated && <span className="auto-badge">ü§ñ T·ª± ƒë·ªông</span>}
                  </div>
                </div>
                <div className="warning-actions">
                  <button 
                    className="action-btn view-btn"
                    onClick={() => {
                      setSelectedWarning(warning);
                      setShowDetailModal(true);
                    }}
                  >
                    üëÅÔ∏è Xem
                  </button>
                  {warning.status === 'pending' && (
                    <button 
                      className="action-btn send-btn"
                      onClick={() => handleSendWarning(warning.id)}
                    >
                      üì§ G·ª≠i
                    </button>
                  )}
                </div>
              </div>
              <div className="warning-description">
                {warning.description}
              </div>
              <div className="warning-footer">
                <span className="warning-date">
                  üìÖ {new Date(warning.createdAt).toLocaleDateString('vi-VN')}
                </span>
                <span 
                  className="status-badge"
                  style={{ 
                    backgroundColor: warning.status === 'pending' ? '#f59e0b' : 
                                   warning.status === 'sent' ? '#3b82f6' : 
                                   warning.status === 'acknowledged' ? '#8b5cf6' : '#10b981'
                  }}
                >
                  {getStatusLabel(warning.status)}
                </span>
              </div>
            </div>
          ))
        )}
      </div>

      {/* Create Warning Modal */}
      {showCreateModal && (
        <div className="modal-overlay">
          <div className="create-warning-modal">
            <div className="modal-header">
              <h3>‚ûï T·∫°o c·∫£nh b√°o m·ªõi</h3>
              <button 
                className="close-btn"
                onClick={() => setShowCreateModal(false)}
              >
                ‚úï
              </button>
            </div>
            
            <div className="modal-content">
              <div className="form-row">
                <div className="form-group">
                  <label>H·ªçc vi√™n:</label>
                  <select 
                    value={newWarning.studentId} 
                    onChange={(e) => setNewWarning({...newWarning, studentId: e.target.value})}
                  >
                    <option value="">Ch·ªçn h·ªçc vi√™n</option>
                    {students.map(student => (
                      <option key={student.id} value={student.id}>
                        {student.fullName}
                      </option>
                    ))}
                  </select>
                </div>
                
                <div className="form-group">
                  <label>Lo·∫°i c·∫£nh b√°o:</label>
                  <select 
                    value={newWarning.type} 
                    onChange={(e) => setNewWarning({...newWarning, type: e.target.value as any})}
                  >
                    <option value="performance">Hi·ªáu su·∫•t</option>
                    <option value="attendance">V·∫Øng m·∫∑t</option>
                    <option value="deadline">Tr·ªÖ h·∫°n</option>
                    <option value="behavior">H√†nh vi</option>
                    <option value="dropout_risk">Nguy c∆° b·ªè h·ªçc</option>
                  </select>
                </div>
                
                <div className="form-group">
                  <label>M·ª©c ƒë·ªô:</label>
                  <select 
                    value={newWarning.severity} 
                    onChange={(e) => setNewWarning({...newWarning, severity: e.target.value as any})}
                  >
                    <option value="low">Th·∫•p</option>
                    <option value="medium">Trung b√¨nh</option>
                    <option value="high">Cao</option>
                    <option value="critical">Nghi√™m tr·ªçng</option>
                  </select>
                </div>
              </div>
              
              <div className="form-group">
                <label>Ti√™u ƒë·ªÅ:</label>
                <input
                  type="text"
                  value={newWarning.title}
                  onChange={(e) => setNewWarning({...newWarning, title: e.target.value})}
                  placeholder="Nh·∫≠p ti√™u ƒë·ªÅ c·∫£nh b√°o..."
                />
              </div>
              
              <div className="form-group">
                <label>N·ªôi dung:</label>
                <textarea
                  value={newWarning.description}
                  onChange={(e) => setNewWarning({...newWarning, description: e.target.value})}
                  placeholder="Nh·∫≠p n·ªôi dung c·∫£nh b√°o..."
                  rows={4}
                />
              </div>
              
              <div className="templates-section">
                <h4>üìù M·∫´u c·∫£nh b√°o c√≥ s·∫µn:</h4>
                <div className="templates-grid">
                  {warningTemplates.map(template => (
                    <button 
                      key={template.id}
                      className="template-card"
                      onClick={() => {
                        setNewWarning({
                          ...newWarning,
                          type: template.type as any,
                          title: template.title,
                          description: template.content,
                          severity: template.severity as any
                        });
                      }}
                    >
                      <div className="template-title">{template.title}</div>
                      <div className="template-type">{getTypeLabel(template.type as any)}</div>
                    </button>
                  ))}
                </div>
              </div>
            </div>
            
            <div className="modal-actions">
              <button 
                className="cancel-btn"
                onClick={() => setShowCreateModal(false)}
              >
                H·ªßy
              </button>
              <button 
                className="create-btn"
                onClick={handleCreateWarning}
                disabled={!newWarning.studentId || !newWarning.title || !newWarning.description}
              >
                T·∫°o c·∫£nh b√°o
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Warning Detail Modal */}
      {showDetailModal && selectedWarning && (
        <div className="modal-overlay">
          <div className="detail-warning-modal">
            <div className="modal-header">
              <h3>üìã Chi ti·∫øt c·∫£nh b√°o</h3>
              <button 
                className="close-btn"
                onClick={() => setShowDetailModal(false)}
              >
                ‚úï
              </button>
            </div>
            
            <div className="modal-content">
              <div className="detail-section">
                <h4>Th√¥ng tin c∆° b·∫£n</h4>
                <div className="detail-grid">
                  <div className="detail-item">
                    <label>H·ªçc vi√™n:</label>
                    <span>{selectedWarning.studentName}</span>
                  </div>
                  <div className="detail-item">
                    <label>Lo·∫°i:</label>
                    <span>{getTypeLabel(selectedWarning.type)}</span>
                  </div>
                  <div className="detail-item">
                    <label>M·ª©c ƒë·ªô:</label>
                    <span 
                      className="severity-badge"
                      style={{ backgroundColor: getSeverityColor(selectedWarning.severity) }}
                    >
                      {getSeverityLabel(selectedWarning.severity)}
                    </span>
                  </div>
                  <div className="detail-item">
                    <label>Tr·∫°ng th√°i:</label>
                    <span>{getStatusLabel(selectedWarning.status)}</span>
                  </div>
                </div>
              </div>
              
              <div className="detail-section">
                <h4>N·ªôi dung</h4>
                <div className="warning-content">
                  <h5>{selectedWarning.title}</h5>
                  <p>{selectedWarning.description}</p>
                </div>
              </div>
              
              {selectedWarning.actions.length > 0 && (
                <div className="detail-section">
                  <h4>H√†nh ƒë·ªông ƒë·ªÅ xu·∫•t</h4>
                  <ul className="actions-list">
                    {selectedWarning.actions.map((action, index) => (
                      <li key={index}>‚úì {action}</li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
            
            <div className="modal-actions">
              <button 
                className="close-btn"
                onClick={() => setShowDetailModal(false)}
              >
                ƒê√≥ng
              </button>
              {selectedWarning.status === 'pending' && (
                <button 
                  className="send-btn"
                  onClick={() => {
                    handleSendWarning(selectedWarning.id);
                    setShowDetailModal(false);
                  }}
                >
                  üì§ G·ª≠i c·∫£nh b√°o
                </button>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default StudentWarningSystem;